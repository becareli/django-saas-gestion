{% extends "gestion/base.html" %}  
{% load crispy_forms_tags %}

{% block title %}
    {% if object %}Editar Proyecto{% else %}Crear Nuevo Proyecto{% endif %}
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <h1 class="page-header">
            <i class="fas fa-{{ object|yesno:'edit,plus-circle' }}"></i> 
            {% if object %}Editar Proyecto: {{ object.nombre }}{% else %}Crear Nuevo Proyecto{% endif %}
        </h1>

        <form method="post">
            {% csrf_token %}
            
            <div class="mb-3">
                <label class="form-label required" for="id_cliente">Cliente*</label>
                <div class="d-flex align-items-center">
                    {{ form.cliente }}
                    <a href="/admin/gestion/cliente/add/?_to_field=id&_popup=1" 
                       class="add-another-btn btn btn-sm btn-info ms-2" 
                       title="Añadir nuevo Cliente" 
                       id="id_cliente">
                        <i class="fas fa-plus"></i>
                    </a>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label required" for="id_tipo">Tipo*</label>
                <div class="d-flex align-items-center">
                    {{ form.tipo }}
                    <a href="/admin/gestion/tipoproyecto/add/?_to_field=id&_popup=1" 
                       class="add-another-btn btn btn-sm btn-info ms-2" 
                       title="Añadir nuevo Tipo de Proyecto" 
                       id="id_tipo">
                        <i class="fas fa-plus"></i>
                    </a>
                </div>
            </div>

            {% for field in form %}
                {% if field.name != 'cliente' and field.name != 'tipo' %}
                    {{ field|as_crispy_field }} 
                {% endif %}
            {% endfor %}
            
            <button type="submit" class="btn btn-primary btn-lg mt-3">
                <i class="fas fa-save"></i> Guardar Proyecto
            </button>
            <a href="{% url 'proyecto-list' %}" class="btn btn-secondary btn-lg mt-3">
                <i class="fas fa-arrow-left"></i> Cancelar
            </a>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script type="text/javascript">
    
    // 1. Función para abrir la ventana emergente (Estándar)
    window.showAddAnotherPopup = function(triggeringLink) {
        var href = triggeringLink.href;
        var name = triggeringLink.id; 
        
        var win = window.open(href, name, 'height=500,width=800,resizable=yes,scrollbars=yes');
        win.focus();
        return false;
    }

    // 2. Función global llamada por el pop-up de Django Admin al guardar un nuevo registro
    window.dismissAddAnotherPopup = function(win, newId, newRepr) {
        win.close();
        
        var id = win.name; // Obtiene el ID del campo (e.g., id_cliente)
        var $select = $('#' + id); 

        if ($select.length) {
            // 1. Crea la nueva opción y la añade al select
            var option_id = newId;
            var $option = $('<option selected></option>').val(option_id).text(newRepr);
            $select.append($option);
            
            // 2. Selecciona el nuevo valor y dispara el evento change
            $select.val(option_id); 
            $select.trigger('change'); 
        }
    }

    // 3. Inicialización del evento (¡CRUCIAL! Asigna el click listener)
    $(document).ready(function() {
        $('.add-another-btn').on('click', function(e) {
            e.preventDefault();
            var btn = this;
            window.showAddAnotherPopup(btn);
        });
    });

</script>
{% endblock %}